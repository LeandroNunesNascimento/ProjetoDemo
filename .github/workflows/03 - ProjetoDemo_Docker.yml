name: 03-ProjetoDemo_Docker

on:
  # We also want to be able to run this manually from Github
  workflow_dispatch:

env:
  ACR_SERVER: 'acrprojetodemo.azurecr.io'

jobs:
  build:

    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v2
      
      - uses: azure/docker-login@v1
        with:
          login-server: ${{ env.ACR_SERVER }}
          username: ${{ secrets.REGISTRY_USERNAME }}
          password: ${{ secrets.REGISTRY_PASSWORD }}
      
      - name: Directory
        run: |
          echo "The default working directory on the runner, it's $GITHUB_WORKSPACE"
          echo "RUN Id = $GITHUB_RUN_ID"
          echo "RUN NUMBER = $GITHUB_RUN_NUMBER"
          ls $GITHUB_WORKSPACE

      - name: Docker Build and Push
        run: |
          cd ./src/
          docker build -t ${{ env.ACR_SERVER }}/projetodemo.webapp:$GITHUB_RUN_NUMBER -t ${{ env.ACR_SERVER }}/projetodemo.webapp:latest -f ProjetoDemo.WebApp/Dockerfile .
          docker push ${{ env.ACR_SERVER }}/projetodemo.webapp:$GITHUB_RUN_NUMBER

  release:
    needs: build
    runs-on: ubuntu-latest

    steps:
      - run: echo 'release'

      #- uses: azure/webapps-deploy@v2.2.3
      #  name: Deploy API
      #  with:
      #    app-name: ${{ env.AZ_API_NAME }}
      #    publish-profile: ${{ secrets.AZURE_PUBLISH_PROFILE_API }}
      #    package: api-artifact
      
      #- uses: azure/webapps-deploy@v2.2.3
      #  name: Deploy APP
      #  with:
      #    app-name: ${{ env.AZ_APP_NAME }}
      #    publish-profile: ${{ secrets.AZURE_PUBLISH_PROFILE_APP }}
      #    package: app-artifact